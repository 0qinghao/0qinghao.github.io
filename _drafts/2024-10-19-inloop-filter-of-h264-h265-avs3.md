---
layout: post
title: 谈一谈 H264 H265 AVS3 环路后处理的异同
categories: [video codec, H264, H265, AVS3]
description: 记录一些 H264 H265 AVS3 标准中环路后处理部分的异同
keywords: H264, AVC, H265, HEVC, AVS3, SVAC, 环路后处理, 去块滤波, DBK, SAO
furigana: false
---

过去几个月我们花了很多时间进行 AVS3(SVAC) 的开发，我负责其中的环路后处理模块。借此机会，我对 H265 的 DBK 和 SAO 模块的理解更进了一步，同时学习了之前不太熟悉的 H264 DBK 模块，当然最重要的是充分理解了 AVS3 的 DBK 和 SAO。

不得不说，经过这个项目的开发，我对国标有了一些改观。以前想的大体是：AVS 不就是为了规避专利费，凑了一堆国内的专家一顿抄，弄出来的 H264/H265 换皮标准吗。实际开始写代码后发现并不完全是这样，国标内确实有一些很棒的、独有的设计，国内专家并不全是吃干饭的，他们也有自己的想法也有自己的野心。至于 AVS 标准整体和 H264/H265 很相似或许只能说是一种必定的巧合，图像视频编解码发展了这么久，整体框架没有大的改动是有理由的：这个框架足够高效、足够稳定、有足够广阔的扩展空间，如果硬要推翻它重新设计一套架构，虽不能说不可能，但确非一朝一夕之功。废话说多了，项目至今 AVS3(SVAC) 的算法开发基本完成，总算有时间总结一下 H264 H265 和 AVS3 环路后处理模块的异同。

# 什么是环路后处理

>句读之不知，惑之不解。     ——韩愈《师说》

首先我们不能断错句，正确的断句是环路（后处理），不能错误地读作（环路后）处理，后者会让人误以为这个环节是在整个编码环路外的。in-loop filter 仍然是在编码-重建环路中的，他是整个环路的最后一步，在预测值+反量化反变换残差后、输出到重建帧 buffer 前，对特定区域、特定数值的数据做些微调，以去除明显的块边界，一定程度上提升主观客观指标。

环路后处理一般指去块滤波 DBK 和自适应样点调节 SAO。H264 仅包含 DBK；H265 包含 DBK 和 SAO；AVS3 除了基础的 DBK 和 SAO 以外，还增加了一些强化版，例如 DBK 后再检查一遍滤波 DBR，例如以 3x3 而不是 3 个点进行模式分类的 ESAO，例如跨颜色分量的 CCSAO。遗憾的是这些强化版大多对硬件不友好，因此我们当前版本的编码器并未支持。

DBK 很容易理解，检查所有 CU/TU 的边界，对满足一定条件的边界做平滑滤波，例如 intra 块和 inter 块的边界由于预测结果的图像特性大概率不是很一致，呈现在画面上很容易有视觉割裂感，因此他们边界处的两侧各 3 个像素参与平滑滤波，可使割裂感大大减弱。DBK 可以说是一个正常编码器必须开启的功能，我们可以简单地看一看不开启 DBK 的后果，显然不是用户能够接受的：

*一个值得注意的细节：帧内预测使用的参考像素，是指进入环路后处理前的数据。这很好理解，DBK 需要用到当前 CTU 周围的像素，当然包括还未编码的下方 CTU，因此只能使用未进行环路后处理的数据做完下方的 CTU，再继续环路后处理。而帧间预测使用的参考像素已经在重建帧 buffer 中了，当然是环路后处理过的数据。*

![](/assets/images/2024-11-10-20-02-54.png)


# DBK 模块的异同


# SAO 模块的异同


# 小结